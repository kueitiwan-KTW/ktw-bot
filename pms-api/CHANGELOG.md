# PMS REST API - Changelog

> PMS è³‡æ–™åº« API æœå‹™çš„è©³ç´°è®Šæ›´è¨˜éŒ„

---

## [1.9.0] - 2025-12-21

### âœ¨ æ–°åŠŸèƒ½ï¼šå‹•æ…‹æ—¥æœŸå…¥ä½æŸ¥è©¢ (Dynamic Check-in Query)

1. **æ–°å¢ `/checkin-by-date` ç«¯é»**
   - **æª”æ¡ˆ**: `routes/bookings.js` (L306-366)
   - **å…§å®¹**: å¯¦ä½œæ”¯æ´ `date` èˆ‡ `offset` åƒæ•¸çš„æŸ¥è©¢é‚è¼¯ã€‚
   - **ç†ç”±**: åŸæœ‰ç«¯é»åƒ…æ”¯æ´ä»Šæ—¥/æ˜æ—¥ï¼Œç„¡æ³•æ»¿è¶³é€±å ±èˆ‡æœˆå ±çš„æ­·å²æˆ–é æœŸæŸ¥è©¢éœ€æ±‚ã€‚
   - **å½±éŸ¿**: LINE Bot èƒ½æº–ç¢ºæŸ¥è©¢ä»»æ„æ—¥æœŸçš„è©³ç´°å…¥ä½åå–®ï¼ˆå«æˆ¿è™Ÿï¼‰ã€‚

### ğŸ”§ éƒ¨ç½²ç®¡ç†æ¨™æº–åŒ– (Operation Standards)

1. **NSSM æœå‹™ç®¡ç†æ¨™æº–åŒ–**
   - **è·¯å¾‘**: `C:\KTW-bot\pms-api\nssm.exe`
   - **å…§å®¹**: ç¢ºèªæœå‹™åç¨±ç‚º `KTW_PMS_API`ã€‚
   - **ç•°å‹•**: å°‡é‡å•ŸæŒ‡ä»¤èˆ‡å·¥ä½œæµè·¯å¾‘æ›´æ–°ç‚ºçµ•å°è·¯å¾‘ï¼Œç¢ºä¿ SSH åŸ·è¡Œç©©å®šæ€§ã€‚

---

## [1.8.0] - 2025-12-19

### ğŸ”§ æœå‹™ç©©å®šæ€§èˆ‡è³‡æ–™åº«ç¶­ä¿®

#### 1. Oracle è³‡æ–™åº«ç£ç¢Ÿ/å¯¦ä¾‹æ•…éšœä¿®å¾© (Server Maintenance)
**æƒ…å¢ƒ**: é ç«¯ä¼ºæœå™¨ (192.168.8.3) è¿”å› `ORA-01034: ORACLE not available` éŒ¯èª¤ã€‚
- **è®Šæ›´**ï¼šé€é SSH é ç«¯ç®¡ç†æ¬Šé™åŸ·è¡Œè³‡æ–™åº«ç¶­ä¿®ã€‚
- **æ“ä½œ**ï¼š
    1. åŸ·è¡Œ `net stop OracleServiceGDWUUKT` åœæ­¢æ›èµ·çš„æœå‹™ã€‚
    2. åŸ·è¡Œ `net start OracleServiceGDWUUKT` é‡æ–°åˆå§‹åŒ–è³‡æ–™åº«å¯¦ä¾‹ã€‚
- **çµæœ**ï¼šPMS API æ¢å¾©æ­£å¸¸é€£ç·šï¼Œè§£æ±ºäº†ç³»çµ±å…¨é¢å´©æ½°çš„ critical blockerã€‚

#### 2. æª”æ¡ˆåŒæ­¥è·¯å¾‘å°é½Š
- **è®Šæ›´**ï¼šé…åˆ Backend API ä¿®å¾©è·¯å¾‘ä¸­çš„ `data/` å‰ç¶´ã€‚

---

## [1.7.3] - 2025-12-19

### âœ¨ æ–°å¢åŠŸèƒ½ï¼šOTA è¨‚å–®è™Ÿç¢¼æ¬„ä½

**æª”æ¡ˆ**: `routes/bookings.js` (L747-749, L770-772, L794-796, L860)

**æ–°å¢æ¬„ä½**: `ota_booking_id`

**èƒŒæ™¯**ï¼š
- LINE Bot éœ€è¦é¡¯ç¤ºå¤–éƒ¨è¨‚å–®ç·¨è™Ÿï¼ˆå¦‚ Agoda çš„ RMAG1667798817ï¼‰è€Œéå…§éƒ¨ IDï¼ˆ00701101ï¼‰
- å…ˆå‰ API é›–ç„¶èƒ½æŸ¥è©¢ OTA è¨‚å–®è™Ÿï¼Œä½†æœªåœ¨å›å‚³ JSON ä¸­åŒ…å«æ­¤æ¬„ä½

**ä¿®æ”¹å…§å®¹**ï¼š

1. **SQL æŸ¥è©¢è£œé½Š** (3 å€‹æŸ¥è©¢ç­–ç•¥)
   ```sql
   -- åœ¨æ‰€æœ‰æŸ¥è©¢ä¸­åŠ å…¥
   TRIM(om.RVRESERVE_NOS) as ota_booking_id
   ```
   - ç­–ç•¥ 1ï¼šIKEY ç²¾ç¢ºåŒ¹é… (L749)
   - ç­–ç•¥ 2ï¼šRVRESERVE_NOS ç²¾ç¢ºåŒ¹é… (L772)
   - ç­–ç•¥ 3ï¼šæ¨¡ç³ŠåŒ¹é… (L796)

2. **JSON å›å‚³çµæ§‹è£œé½Š** (L860)
   ```javascript
   {
     booking_id: "00701101",        // å…§éƒ¨ ID
     ota_booking_id: "RMAG1667798817",  // OTA å¤–éƒ¨ç·¨è™Ÿï¼ˆæ–°å¢ï¼‰
     guest_name: "...",
     // ... å…¶ä»–æ¬„ä½
   }
   ```

**æ¸¬è©¦çµæœ**ï¼š
```bash
curl "http://192.168.8.3:3000/api/bookings/1667798817"
# è¿”å›åŒ…å« "ota_booking_id": "RMAG1667798817" âœ…
```

**å½±éŸ¿ç¯„åœ**ï¼š
- LINE Bot ç¾åœ¨èƒ½æ­£ç¢ºé¡¯ç¤º OTA è¨‚å–®ç·¨è™Ÿ
- æå‡ç”¨æˆ¶é«”é©—ï¼ˆå®¢äººæ›´å®¹æ˜“æ ¸å°è¨‚å–®ï¼‰

---

## [1.7.2] - 2025-12-19

### ğŸ”§ Bug ä¿®å¾©ï¼šOTA è¨‚å–®è™ŸæŸ¥è©¢åŠŸèƒ½

**æª”æ¡ˆ**: `routes/bookings.js` (L731-807)

**å•é¡Œ**: ç”¨æˆ¶ä½¿ç”¨ Agoda/Booking è¨‚å–®è™ŸæŸ¥è©¢æ™‚æŸ¥ä¸åˆ°è¨‚å–®

**æ ¹æœ¬åŸå› **: OTA è¨‚å–®è™Ÿå­˜å„²åœ¨ `RVRESERVE_NOS` æ¬„ä½ï¼Œä½†æŸ¥è©¢é‚è¼¯åªæŸ¥ `IKEY` æ¬„ä½

**è§£æ±ºæ–¹æ¡ˆ**: å¯¦ä½œä¸‰å±¤æŸ¥è©¢ç­–ç•¥

1. **ç¬¬ä¸€å±¤ï¼šIKEY ç²¾ç¢ºåŒ¹é…** (L732-750)
   - æŸ¥è©¢ PMS å…§éƒ¨è¨‚å–®è™Ÿ
   - ä¾‹å¦‚ï¼š`00701101`

2. **ç¬¬äºŒå±¤ï¼šRVRESERVE_NOS ç²¾ç¢ºåŒ¹é…** (L753-773)
   - æŸ¥è©¢ OTA è¨‚å–®è™Ÿï¼ˆæ–°å¢ï¼‰
   - æ”¯æ´ `RMAG1667798817` (Agoda)
   - æ”¯æ´ `RMPGP250298503` (Booking)

3. **ç¬¬ä¸‰å±¤ï¼šæ¨¡ç³ŠåŒ¹é…** (L776-797)
   - åŒæ™‚åœ¨ IKEY å’Œ RVRESERVE_NOS ä¸­æ¨¡ç³ŠåŒ¹é…
   - æ”¯æ´åªç”¨æ•¸å­—éƒ¨åˆ†æŸ¥è©¢ï¼ˆä¾‹å¦‚ï¼š`1667798817` â†’ `RMAG1667798817`ï¼‰

**æ¸¬è©¦çµæœ**:
- âœ… `1667798817` â†’ æˆåŠŸæ‰¾åˆ° `RMAG1667798817`
- âœ… `250298503` â†’ æˆåŠŸæ‰¾åˆ° `RMPGP250298503`  
- âœ… `RMAG1677888347` â†’ ç²¾ç¢ºåŒ¹é…æˆåŠŸ

**å½±éŸ¿ç¯„åœ**: 
- ä¿®å¾© Bot è¨‚å–®æŸ¥è©¢å¤±æ•—å•é¡Œ
- å¤§å¹…æå‡ç”¨æˆ¶é«”é©—ï¼ˆæ”¯æ´å¤šç¨®è¨‚å–®è™Ÿæ ¼å¼ï¼‰

---

## [1.7.1] - 2025-12-18

### âš¡ API ç°¡åŒ–èˆ‡å„ªåŒ– (Optimization)

#### 1. ç§»é™¤å†—é¤˜æŸ¥è©¢åƒæ•¸
**æª”æ¡ˆ**: `routes/bookings.js` (L18-60)

- **ä¿®æ”¹å…§å®¹**ï¼šå¾ `/api/bookings/search` ç«¯é»ç§»é™¤ `id` æŸ¥è©¢åƒæ•¸ã€‚
- **åŸå› **ï¼šç‚ºäº†æ¸›å°‘èˆ‡æ—¢å­˜å–®ä¸€è¨‚å–®æŸ¥è©¢ç«¯é» `GET /api/bookings/:booking_id` çš„åŠŸèƒ½é‡ç–Šèˆ‡æ··æ·†ã€‚
- **å½±éŸ¿**ï¼š`/search` ç«¯é»ç¾åœ¨åƒ…æ¥æ”¶ `name` èˆ‡ `phone` åƒæ•¸ï¼Œç¬¦åˆå°ˆæ¡ˆ Scenario B çš„æ¶æ§‹è¦åŠƒã€‚

---

## [1.7.0] - 2025-12-17

### âœ¨ æ–°åŠŸèƒ½ï¼šè¨‚å–®ç‹€æ…‹å›å¯«

#### 1. Mismatch ç‹€æ…‹æ¨™è¨˜
**æª”æ¡ˆ**: `routes/bookings.js`

- **æ–°å¢ç«¯é»**: `PATCH /api/bookings/same-day/:order_id/mismatch` (L586-650)
- **åŠŸèƒ½**: å°‡ `same_day_bookings.json` ä¸­çš„è¨‚å–®ç‹€æ…‹æ›´æ–°ç‚º `mismatch`
- **ç”¨é€”**: ç•¶ Admin Web é»æ“Šã€Œå·² KEYã€ä½†è‡ªå‹•æ¯”å°å¤±æ•—æ™‚å‘¼å«
- **å¯¦ä½œ**:
  ```javascript
  // è®€å–è¨‚å–® -> æ‰¾åˆ°å°æ‡‰ ID -> æ›´æ–° status = 'mismatch' -> å¯«å›æª”æ¡ˆ
  targetBooking.status = 'mismatch';
  await fs.promises.writeFile(itemPath, JSON.stringify(bookings, null, 2));
  ```

#### 2. Check-in é‚è¼¯å¢å¼·
**æª”æ¡ˆ**: `routes/bookings.js` (L542-610)

- **ä¿®æ”¹**: `checkin` ç«¯é»ç¾åœ¨æœƒå…ˆåŸ·è¡Œ PMS é›»è©±æ¯”å°
- **é‚è¼¯**: 
  - Admin Web è§¸ç™¼ -> Backend API é©—è­‰ -> æ¯”å°æˆåŠŸ -> å‘¼å« PMS `/checkin`
  - æ¯”å°å¤±æ•— -> Backend API å‘¼å« PMS `/mismatch`

### ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶
- `routes/bookings.js` (L542-610, L586-650) - æ–°å¢èˆ‡ä¿®æ”¹ Check-in/Mismatch é‚è¼¯

---

## [1.6.0] - 2025-12-11

### âœ¨ æ–°åŠŸèƒ½ï¼šWindows æœå‹™æ”¯æ´

1. **æœå‹™ç®¡ç†è…³æœ¬**
   - **æª”æ¡ˆ**: `manage-service.bat`
   - **åŠŸèƒ½**: æ•´åˆ Start/Stop/Restart/Status åŠŸèƒ½çš„æ‰¹æ¬¡æª”
   - **ä½ç½®**: å°ˆæ¡ˆæ ¹ç›®éŒ„

2. **å®‰è£/ç§»é™¤è…³æœ¬**
   - **æª”æ¡ˆ**: `install_service.js`, `uninstall_service.js`
   - **åŠŸèƒ½**: ä½¿ç”¨ `node-windows` å°‡ API è¨»å†Šç‚º Windows æœ¬åœ°æœå‹™
   - **è¨­å®š**: è‡ªå‹•è™•ç†é€£ç·šé‡è©¦èˆ‡éŒ¯èª¤é‡å•Ÿ

### ğŸ› Bug ä¿®å¾©

1. **Oracle é€£ç·šè¶…æ™‚ (ORA-12170)**
   - **æª”æ¡ˆ**: `.env`, `listener.ora` (Server Side)
   - **å•é¡Œ**: `ORACLE_HOME` ç’°å¢ƒè®Šæ•¸è¡çªèˆ‡ SID é…ç½®éŒ¯èª¤
   - **ä¿®å¾©**: ä¿®æ­£ç’°å¢ƒè®Šæ•¸ä¸¦é‡å•Ÿç›£è½å™¨

2. **é˜²ç«ç‰†é˜»æ“‹**
   - **è¨­å®š**: Windows Firewall
   - **ä¿®å¾©**: é–‹æ”¾ Inbound Port 3000

---

## [1.0.0] - 2025-12-10

### åˆå§‹ç‰ˆæœ¬
- å»ºç«‹ Oracle DB é€£ç·šæ± 
- è¨‚å–®æŸ¥è©¢ API (Search by name/phone)
- æˆ¿æ³æŸ¥è©¢ API (Room availability)
- è¨‚å–®è©³æƒ… API
