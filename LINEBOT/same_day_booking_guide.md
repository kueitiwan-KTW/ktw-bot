# LINE Bot 當日預訂功能說明

## 功能概述

當日預訂功能讓客人可以透過 LINE Bot 直接預訂當天的房間，無需透過官網或電話。

### 特點
- 即時查詢當日房價（從 PMS API 獲取）
- 支援單一房型和多房型預訂
- 自動庫存檢查和升等處理
- 訂單同步至 Dashboard 和客人對話記錄

---

## 對話流程

### 觸發方式
客人發送包含以下關鍵字的訊息：
- 「今天想住」、「現在有房嗎」、「還有空房嗎」
- 「臨時訂房」、「當日預訂」

### 流程圖

```
客人觸發 → 顯示房型列表 → 選擇房型
                              ↓
            ┌─────────────────┴─────────────────┐
            ↓                                   ↓
      單一房型                              多房型
      (輸入數字)                      (輸入組合文字)
            ↓                                   ↓
      選擇數量 (1-4間)                    自動解析房型
            ↓                                   ↓
      選擇床型                           檢查庫存
            ↓                                   ↓
      檢查庫存                                 ↓
            ↓                                   ↓
            └─────────────┬─────────────────────┘
                          ↓
                   收集客人資訊
                   (姓名、電話、抵達時間)
                          ↓
                   確認預訂
                          ↓
                   建立訂單 → Dashboard + guest_orders.json
```

---

## 輸入格式

### 單一房型
```
客人：2          → 選擇標準雙人房
客人：3          → 選擇標準三人房
客人：4          → 選擇標準四人房
```

### 多房型組合
```
客人：1間雙人1間三人
客人：2間雙人房1間四人房
客人：1雙人2三人
```

支援的關鍵字：
| 關鍵字 | 對應房型 |
|--------|----------|
| 雙人、雙人房、兩人、2人 | 標準雙人房 |
| 三人、三人房、3人 | 標準三人房 |
| 四人、四人房、4人 | 標準四人房 |

---

## 業務規則

### 預訂時間限制
- **服務時間**：每日 22:00 前
- **抵達時間**：僅接受當日 22:00 前抵達

### 房間數量限制
- **單一房型**：1-4 間
- **多房型總計**：最多 4 間
- **5 間以上**：導向官網預訂

### 床型選項
| 房型 | 可選床型 |
|------|----------|
| 標準雙人房 | 一大床、兩小床 |
| 標準三人房 | 一大床+一小床、三小床 |
| 標準四人房 | 兩大床、四小床 |

### 價格來源
- 從 PMS API 即時獲取當日房價
- 所有房價**含早餐**

---

## 取消預訂

### 客人自助取消
客人發送以下關鍵字可觸發取消流程：
- 「取消訂單」、「取消預訂」
- 「不住了」、「不要了」、「不來了」

### 取消流程
```
客人：不住了
BOT：📋 您有一筆待入住的當日預訂：...
     1️⃣ 確認取消
     2️⃣ 保留訂單

客人：1
BOT：✅ 已為您取消訂單！
```

---

## API 端點

### PMS API (192.168.8.3:3000)

| 端點 | 方法 | 說明 |
|------|------|------|
| `/api/rooms/today-availability` | GET | 查詢今日房況和房價 |
| `/api/bookings/same-day` | POST | 建立當日預訂 |
| `/api/bookings/same-day-list` | GET | 查詢當日預訂列表 |
| `/api/bookings/same-day/:order_id/cancel` | PATCH | 取消訂單 |
| `/api/bookings/same-day/:order_id/checkin` | PATCH | 標記已 KEY |

---

## Dashboard 操作

### 訪問方式
- 網址：`http://localhost:5002` 或 `http://192.168.10.249:5002`

### 當日預訂區塊
顯示所有當日預訂，包含：
- 訂單時間
- 房型 + 床型
- 客人姓名 / 電話
- LINE 姓名
- 抵達時間
- 狀態（待入住/已KEY/已取消）

### 操作按鈕
- **標記已 KEY**：客人入住後點擊
- **取消**：取消該筆訂單

---

## 檔案結構

```
KTW-bot/
├── same_day_booking.py      # 當日預訂對話狀態機
├── pms_client.py            # PMS API 客戶端
├── chat_logs/
│   └── guest_orders.json    # 客人對話記錄（含當日預訂）
└── pms-api/
    ├── routes/bookings.js   # 當日預訂 API 端點
    └── data/
        └── same_day_bookings.json  # 當日預訂暫存資料
```

---

## 注意事項

1. **無訂金**：當日預訂不收取訂金，館方保留臨時取消權利
2. **訂單記錄**：同時寫入 PMS API 和 guest_orders.json
3. **多房型訂單**：每個房型產生獨立訂單編號
4. **升等處理**：庫存不足時自動檢查可升等房型
