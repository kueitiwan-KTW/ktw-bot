# LINE Bot 專案遷移指南（Mac to Mac）

> 📅 建立日期：2025-12-09  
> 🎯 目的：將整個專案完整遷移到另一台 Mac 電腦

---

## ⚠️ 重要注意事項

### 🔐 敏感資訊檔案（必須備份）

以下檔案包含**敏感資訊**，遺失將無法運作：

| 檔案 | 內容 | 重要性 |
|------|------|--------|
| **`.env`** | API 金鑰、LINE Token、Google API Key | ⭐⭐⭐⭐⭐ 極重要 |
| **`token.json`** | Google OAuth 認證令牌 | ⭐⭐⭐⭐⭐ 極重要 |
| **`credentials.json`** | Google API 憑證 | ⭐⭐⭐⭐⭐ 極重要 |
| **`knowledge_base.json`** | 知識庫資料 | ⭐⭐⭐⭐ 重要 |
| **`room_type_mapping.json`** | 房型對應設定 | ⭐⭐⭐ 中等 |

**重要**：這些檔案包含您的私密金鑰，**絕對不可以上傳到 GitHub 或公開分享**！

---

## 📦 打包前檢查清單

### ✅ 步驟 1：確認資料完整性

```bash
# 進入專案目錄
cd /Users/like/Desktop/line@訂單客服AGA

# 檢查關鍵檔案是否存在
ls -la .env token.json credentials.json knowledge_base.json
```

### ✅ 步驟 2：備份資料庫/資料檔案

您的系統使用以下資料儲存方式：
- **知識庫**：`knowledge_base.json`（16KB）
- **聊天記錄**：`chat_logs/` 目錄
- **LINE 歷史資料**：`line_history_data/` 目錄（3,291 個檔案）

**建議**：這些都要一併打包！

### ✅ 步驟 3：排除不必要的檔案

以下檔案/目錄**不需要**打包（可節省空間並避免問題）：

```bash
.venv/              # Python 虛擬環境（到新電腦重新建立）
.git/               # Git 版本控制（如果有的話）
__pycache__/        # Python 快取檔案
*.pyc               # Python 編譯檔案
.DS_Store           # macOS 系統檔案
bot.log             # 舊的日誌檔案（可選）
bot_debug.log       # Debug 日誌（可選）
ngrok                # ngrok 執行檔（新電腦重新下載）
```

---

## 📋 完整遷移步驟

### 方案一：使用壓縮檔打包（✅ 推薦）

#### 在原電腦（來源端）：

```bash
# 1. 進入專案父目錄
cd /Users/like/Desktop

# 2. 建立壓縮檔（排除不必要的檔案）
tar -czf line-bot-backup-$(date +%Y%m%d).tar.gz \
  --exclude='.venv' \
  --exclude='.git' \
  --exclude='__pycache__' \
  --exclude='*.pyc' \
  --exclude='.DS_Store' \
  --exclude='ngrok' \
  "line@訂單客服AGA"

# 3. 檢查壓縮檔大小
ls -lh line-bot-backup-*.tar.gz

# 預期大小：約 20-50 MB（視 line_history_data 大小而定）
```

#### 傳輸到新電腦：

選擇以下任一方式：
- **AirDrop**（最簡單，Mac to Mac 專用）
- **USB 隨身碟**
- **iCloud Drive / Google Drive**（如果檔案不大）
- **網路直傳**：`scp line-bot-backup-*.tar.gz user@new-mac-ip:~/Desktop/`

#### 在新電腦（目標端）：

```bash
# 1. 解壓縮
cd ~/Desktop
tar -xzf line-bot-backup-*.tar.gz

# 2. 進入專案目錄
cd "line@訂單客服AGA"

# 3. 檢查關鍵檔案
ls -la .env token.json credentials.json

# ✅ 確認都存在即可繼續
```

---

### 方案二：使用 rsync 同步（適合區域網路）

如果兩台 Mac 在同一網路：

```bash
# 在原電腦執行（需替換新電腦的 IP 位址）
rsync -avz --progress \
  --exclude='.venv' \
  --exclude='.git' \
  --exclude='__pycache__' \
  --exclude='*.pyc' \
  --exclude='.DS_Store' \
  --exclude='ngrok' \
  "/Users/like/Desktop/line@訂單客服AGA" \
  username@新電腦IP:~/Desktop/
```

---

## 🔧 新電腦環境設定

### 步驟 1：檢查 Python 版本

```bash
python3 --version

# 必須是 Python 3.8 以上
# 如果沒有安裝，請先安裝 Python 3
```

### 步驟 2：建立虛擬環境

```bash
cd ~/Desktop/line@訂單客服AGA

# 建立新的虛擬環境
python3 -m venv .venv

# 啟動虛擬環境
source .venv/bin/activate

# 確認虛擬環境已啟動（命令列前面會有 (.venv) 標記）
```

### 步驟 3：安裝相依套件

```bash
# 確保虛擬環境已啟動
pip install --upgrade pip

# 安裝所有必要套件
pip install -r requirements.txt

# 預期安裝以下套件：
# - flask
# - line-bot-sdk
# - google-api-python-client
# - google-auth-httplib2
# - google-auth-oauthlib
# - Pillow
# - google-generativeai
# - python-dotenv
```

### 步驟 4：驗證環境變數

```bash
# 檢查 .env 檔案
cat .env

# 應該要看到：
# - LINE_CHANNEL_ACCESS_TOKEN
# - LINE_CHANNEL_SECRET
# - GOOGLE_API_KEY
# - PORT
# - CWA_API_KEY
```

### 步驟 5：下載 ngrok（如果需要）

```bash
# 前往 ngrok 官網下載 macOS 版本
# https://ngrok.com/download

# 或使用 Homebrew 安裝
brew install ngrok

# 如果已下載執行檔，放到專案目錄：
# cp ~/Downloads/ngrok ./ngrok
# chmod +x ./ngrok
```

---

## ✅ 測試運行

### 測試步驟

```bash
# 1. 確保在專案目錄
cd ~/Desktop/line@訂單客服AGA

# 2. 確保虛擬環境已啟動
source .venv/bin/activate

# 3. 執行啟動腳本
chmod +x run_dev.sh
./run_dev.sh
```

### 預期看到的訊息

```
===========================================
🏨 LINE Bot 客服系統 + 管理後台
===========================================
🧹 清理舊程序和 Port...
   ✅ Port 5001 已釋放
   ✅ Port 5002 已釋放
===========================================
🚀 啟動服務...
===========================================

🤖 啟動 LINE Bot (Port 5001)...
   進程 ID: XXXXX

🏨 啟動管理後台 (Port 5002)...
   進程 ID: XXXXX

===========================================
✅ 服務啟動完成！
===========================================

📍 LINE Bot:       http://localhost:5001
📍 管理後台:       http://localhost:5002
```

### 測試功能

開啟瀏覽器測試：

1. **後台首頁**：http://localhost:5002
   - 應該能看到入住管理頁面
   
2. **Rich Menu 管理**：http://localhost:5002/rich-menu
   - 應該能看到 Rich Menu 編輯介面

---

## ⚠️ 常見問題與解決方案

### 問題 1：找不到 Python 套件

**錯誤訊息**：
```
ModuleNotFoundError: No module named 'flask'
```

**解決方法**：
```bash
# 確認虛擬環境已啟動
source .venv/bin/activate

# 重新安裝套件
pip install -r requirements.txt
```

---

### 問題 2：Port 被佔用

**錯誤訊息**：
```
OSError: [Errno 48] Address already in use
```

**解決方法**：
```bash
# 清理被佔用的 Port
lsof -ti:5001 | xargs kill -9
lsof -ti:5002 | xargs kill -9

# 重新啟動
./run_dev.sh
```

---

### 問題 3：環境變數載入失敗

**症狀**：系統啟動但無法連接 LINE API 或 Google API

**解決方法**：
```bash
# 1. 檢查 .env 檔案是否存在
ls -la .env

# 2. 檢查內容是否完整
cat .env

# 3. 確認沒有多餘的空格或特殊字元

# 4. 如果有問題，重新編輯
nano .env
```

---

### 問題 4：Google 認證失效

**錯誤訊息**：
```
google.auth.exceptions.RefreshError
```

**解決方法**：
```bash
# 刪除舊的 token.json
rm token.json

# 重新執行需要 Google 認證的功能
# 系統會自動開啟瀏覽器要求重新授權
python3 gmail_helper.py
```

---

### 問題 5：ngrok 執行權限問題

**錯誤訊息**：
```
Permission denied: ./ngrok
```

**解決方法**：
```bash
chmod +x ./ngrok
```

---

## 📁 最終目錄結構檢查

遷移完成後，確認以下結構：

```
line@訂單客服AGA/
├── .env                          ✅ 必須存在
├── .venv/                        ✅ 重新建立
├── admin_dashboard.py            ✅
├── app.py                        ✅
├── bot.py                        ✅
├── credentials.json              ✅ 必須存在
├── token.json                    ✅ 必須存在
├── knowledge_base.json           ✅ 必須存在
├── room_type_mapping.json        ✅
├── requirements.txt              ✅
├── run_dev.sh                    ✅
├── templates/                    ✅
│   ├── today_checkins.html
│   ├── rich_menu_manager.html
│   └── message_board_component.html
├── chat_logs/                    ✅ 會自動建立
├── line_history_data/            ✅ 如有備份應存在
└── 其他 Python 檔案              ✅
```

---

## 🔒 安全性注意事項

### ⚠️ 絕對不可以做的事

1. **不要將 `.env` 檔案上傳到 GitHub**
   - 包含所有 API 金鑰和 Token

2. **不要將 `token.json` 和 `credentials.json` 公開**
   - 這是您的 Google 帳號授權

3. **不要在公開場合分享 LINE Channel Access Token**
   - 會導致任何人都能以您的 Bot 身份發送訊息

### ✅ 建議的安全措施

```bash
# 在新電腦設定正確的檔案權限
chmod 600 .env
chmod 600 token.json
chmod 600 credentials.json

# 這樣只有您的使用者帳號可以讀取
```

---

## 🎯 遷移檢查清單

完成遷移後，逐項勾選：

- [ ] ✅ 所有檔案已成功傳輸
- [ ] ✅ 敏感檔案（.env, token.json, credentials.json）存在且內容正確
- [ ] ✅ Python 3 已安裝
- [ ] ✅ 虛擬環境已建立（.venv/）
- [ ] ✅ 所有依賴套件已安裝（pip install -r requirements.txt）
- [ ] ✅ ngrok 已下載並設定執行權限（如果需要）
- [ ] ✅ 執行 `./run_dev.sh` 成功啟動
- [ ] ✅ 瀏覽器可以開啟 http://localhost:5002
- [ ] ✅ 後台管理介面正常顯示
- [ ] ✅ Rich Menu 管理功能正常
- [ ] ✅ LINE Bot 回應測試正常（發送訊息測試）
- [ ] ✅ Google Gmail 整合正常（查詢訂單測試）

---

## 🆘 緊急救援

如果遇到無法解決的問題：

### 完整重置步驟

```bash
# 1. 停止所有服務
pkill -9 -f "python3.*app.py"
pkill -9 -f "python3.*admin_dashboard.py"

# 2. 清理 Port
lsof -ti:5001 | xargs kill -9
lsof -ti:5002 | xargs kill -9

# 3. 刪除虛擬環境
rm -rf .venv

# 4. 重新建立環境
python3 -m venv .venv
source .venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt

# 5. 重新啟動
./run_dev.sh
```

---

## 📞 技術支援資訊

- **Python 官方文件**：https://docs.python.org/3/
- **Flask 文件**：https://flask.palletsprojects.com/
- **LINE Bot SDK**：https://github.com/line/line-bot-sdk-python
- **ngrok 文件**：https://ngrok.com/docs

---

## 🎓 額外建議

### 版本控制

遷移完成後，建議設定 Git 版本控制：

```bash
cd ~/Desktop/line@訂單客服AGA

# 初始化 Git
git init

# 建立 .gitignore 檔案
cat > .gitignore << EOF
# 敏感資訊
.env
token.json
credentials.json

# Python
.venv/
__pycache__/
*.pyc

# 系統檔案
.DS_Store
*.log

# 暫存檔案
chat_logs/
EOF

# 首次提交
git add .
git commit -m "Initial commit - LINE Bot 專案"
```

### 定期備份

建議定期備份以下檔案：
- `knowledge_base.json`（知識庫更新後）
- `room_type_mapping.json`（房型設定變更後）
- `chat_logs/`（重要對話記錄）

---

> 📌 **最後提醒**：遷移完成後，請妥善保管原電腦的備份，直到確認新電腦運作正常至少 1-2 週。
