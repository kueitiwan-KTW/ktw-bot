# LINE BOT 與 PMS API 整合方案分析

## 現況分析

**LINE BOT 目前架構**：
- 資料來源：Gmail API（查詢訂單郵件）
- 查詢方式：透過訂單編號搜尋郵件
- 顯示資訊：從郵件內容解析訂單詳情

**PMS 資料庫現況**：
- 系統：Oracle Database 12.2.0
- 資料表：ORDER_MN（訂單主檔）、ORDER_DT（訂單明細）
- 資料完整性：包含所有訂房資訊

---

## 整合方案比較

### 方案 A：API 作為主要資料源

**架構**：
```
LINE BOT → PMS REST API → Oracle Database → 回傳訂單資料
```

**優點**：
- ✅ **資料即時**：直接查詢 PMS 官方資料庫
- ✅ **資料完整**：可取得所有訂單欄位
- ✅ **資料一致**：無同步問題
- ✅ **未來擴充性**：可串接其他功能（修改訂單、查詢房況等）

**缺點**：
- ⚠️ 需要建立 REST API 服務
- ⚠️ 需要調整現有 BOT 查詢邏輯
- ⚠️ 需要維護 API 服務

**建議場景**：
- 需要完整訂房管理功能
- 計劃未來擴充更多訂房相關服務

---

### 方案 B：Gmail + API 雙軌並行

**架構**：
```
LINE BOT → 優先查詢 Gmail
         ↓ 找不到
         → 查詢 PMS API → Oracle Database
```

**優點**：
- ✅ **漸進式整合**：保留現有功能
- ✅ **向後相容**：舊流程不受影響
- ✅ **資料備援**：雙重資料來源

**缺點**：
- ⚠️ **資料可能不同步**：Gmail 與 PMS 資料可能有差異
- ⚠️ **維護複雜度**：需要維護兩套查詢邏輯
- ⚠️ **效能較差**：可能需要查詢兩次

**建議場景**：
- 希望平滑過渡到新系統
- Gmail 郵件覆蓋率不完整，需要 PMS 補充

---

### 方案 C：維持 Gmail，PMS 僅供後台

**架構**：
```
LINE BOT → 僅查詢 Gmail（不變）
PMS API → 僅供管理後台使用
```

**優點**：
- ✅ **BOT 無變動**：不影響現有功能
- ✅ **風險最低**：無需調整 BOT 邏輯
- ✅ **快速上線**：PMS API 獨立開發

**缺點**：
- ❌ **無整合效益**：BOT 無法使用 PMS 資料
- ❌ **資料分散**：無法統一管理
- ❌ **功能受限**：無法提供即時房況等進階功能

**建議場景**：
- Gmail 資料已足夠完整
- 僅需要後台管理工具

---

## BOT 需要的訂單欄位

根據程式碼分析，BOT 顯示訂單時需要以下欄位：

### 必要欄位
| 欄位名稱 | PMS 對應欄位 | 說明 |
|---------|------------|------|
| 訂單編號 | `ORDER_MN.IKEY` | 主鍵 |
| 訂房人 | `ORDER_MN.CUST_NAM` | 客人姓名 |
| 訂房來源 | `ORDER_MN.SOURCE_TYP` | Agoda/官網等 |
| 入住日期 | `ORDER_MN.CI_DAT` | Check-in |
| 退房日期 | `ORDER_MN.CO_DAT` | Check-out |
| 住宿晚數 | `ORDER_MN.DAYS` | 計算天數 |
| 房型 | `ORDER_DT.ROOM_COD` + `ROOM_RF.ROOM_NAM` | 雙人房/四人房等 |
| 房間數量 | `ORDER_DT.ORDER_QNT` | X 間 |

### 選用欄位
| 欄位名稱 | PMS 對應欄位 | 說明 |
|---------|------------|------|
| 早餐資訊 | 需確認欄位 | 有/無 |
| 成人數 | `ORDER_DT.ADULT_QNT` | X 人 |
| 兒童數 | `ORDER_DT.CHILD_QNT` | X 人 |
| 聯絡電話 | `ORDER_MN.CONTACT1_RMK` | 查詢用 |
| 訂單狀態 | `ORDER_MN.ORDER_STA` | 已確認/已入住/已退房 |

---

## 建議採用：方案 A（API 為主）

**理由**：
1. ✅ **長期價值**：可擴充更多功能（查房況、修改訂單等）
2. ✅ **資料準確**：直接查詢官方資料庫
3. ✅ **技術可行**：已完成 Oracle 連接與 API 設計

**實作步驟**：
1. ✅ 完成 PMS API 開發（已設計規格）
2. ⏳ 調整 BOT 的 `check_order_status` 函式
3. ⏳ 新增查詢 PMS API 的邏輯
4. ⏳ 測試與部署

---

## 下一步行動

請確認：
1. **選擇哪個方案**？（建議方案 A）
2. **早餐資訊**在 PMS 的哪個欄位？
3. **是否需要其他欄位**？（特殊需求、備註等）

確認後即可開始實作 API！
